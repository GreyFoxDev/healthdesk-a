<link rel="stylesheet" href="https://uselooper.com/assets/vendor/flatpickr/flatpickr.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.3/flatpickr.min.js" integrity="sha256-/irFIZmSo2CKXJ4rxHWfrI+yGJuI16Z005X/bENdpTY=" crossorigin="anonymous"></script>

<%= if assigns[:new]  do %>

<header class="page-title-bar">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item active">
                <a href="#" phx-click="back"><i class="breadcrumb-icon fa fa-angle-left mr-2"></i>Conversations</a>
            </li>
        </ol>
    </nav>
    <h1 class="page-title">New Conversation</h1>
</header>

<div class="panel-body">
    <section id="base-style" class="card">
        <div class="card-header nav-scroller">
            <!-- .nav-tabs -->
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <a class="nav-link show active" id="rd1" href="#">Personal</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="rd2" href="#">Campaign</a>
                </li>
            </ul><!-- /.nav-tabs -->
        </div>
        <div class="card-body">
            <%= f = form_for @changeset, "#", [ phx_submit: :new_msg, multipart: true] %>
            <fieldset>
                <div class="form-group form_csv">
                    <label for="tf3">CSV Upload</label>
                    <div class="custom-file">
                        <%= file_input f, :csv, accept: "text/csv, .csv", class: "custom-file-input", placeholder: "Choose file" %>
                        <label class="custom-file-label" for="tf3">Choose file</label>
                        <small id="tf1Help" class="form-text text-muted">Please upload a csv file with Firstname, Lastname and Mobile Number. <a href="#">Click here</a> to download a sample csv.</small>
                    </div>
                </div>
                <div class="form-group form_to">
                    <label>To</label>
                    <%= text_input f, :original_number, class: "form-control" %>
                </div>
                <div class="form-group form_name">
                    <label>Campaign Name</label>
                    <%= text_input f, :campaign_name, class: "form-control" %>
                </div>
                <div class="form-group">
                    <label>Message</label>
                    <%= textarea f, :message, class: "form-control", place_holder: "Type a message", rows: 6 %>
                </div>
                <div class="form-group form_schedule">
                    <div class="custom-control custom-checkbox mb-3">
                        <input type="checkbox" class="custom-control-input" id="conversation_scheduled" name="conversation[scheduled]">
                        <label class="custom-control-label" for="conversation_scheduled">Schedule Campaign</label>
                        <div class="invalid-tooltip"> You must agree before submitting. </div>
                    </div>
                </div>
                <div class="form-group form_date">
                    <label class="control-label" for="flatpickr02">Date and Time</label>
                    <input id="conversation_send_at"
                           name="conversation[send_at]"
                           type="text"
                           class="form-control flatpickr-input active"
                           data-toggle="flatpickr"
                           data-enable-time="true"
                           data-date-format="Y-m-d H:i"
                           readonly="readonly">
                </div>
                <div class="media mb-1">
                    <div>
                        <button type="submit" class="btn btn-primary">
                            <i class="far fa-paper-plane"></i>
                            <span class="form_btn">Send Now</span>
                        </button>
                    </div>
                </div><!-- /.media -->
            </fieldset>
            </form>
        </div>
    </section>
</div>

<div class="aside-backdrop"></div></div> <!-- /container -->

<% else  %>
<%= if assigns[:conversation_id]  do %>
<article class="message">

    <header class="message-header">
        <div class="d-flex">
            <a class="btn btn-light btn-icon" phx-click="back"><i class="fa fa-flip-horizontal fa-share"></i></a>
        </div>

        &nbsp;
        &nbsp;
        <div class="team">
            <h4 class="list-group-item-title">
                <%= if @conversation.member && @conversation.member.first_name do %>
                Message from
                <strong><%= Enum.join([@conversation.member.first_name, @conversation.member.last_name], " ") %></strong>
                <% else %>
                Message from <strong><%= format_phone(@conversation.original_number) %></strong>
                <% end %>
            </h4>
            <%= if @conversation.team_member_id do %>
            <p class="list-group-item-text">
                Assigned to:
                <%= @conversation.team_member.user.first_name %>
                <%= @conversation.team_member.user.last_name %>
            </p>
            <% else %>
            <p class="list-group-item-text">
                Assigned to: <%= format_assigned(@conversation.original_number) %>
            </p>
            <% end %>
        </div>

        <div class="message-header-actions">
            <!-- invite members -->
            <%= if @conversation.status in ["open", "pending", "closed"] do %>
            <div class="dropdown d-inline-block">
                <%= if @conversation.status in ["open", "pending"] do  %>

                <button type="button" class="btn btn-light btn-icon" title="Invite members" data-toggle="dropdown"
                        data-display="static" aria-haspoppup="true" aria-expanded="false"><i
                        class="fas fa-user-plus"></i></button>
                <div class="dropdown-arrow"></div><!-- .dropdown-menu -->
                <div class="dropdown-menu dropdown-menu-right dropdown-menu-rich stop-propagation">

                    <div class="dropdown-header"> Assign Conversation</div>
                    <div class="form-group px-3 py-2 m-0">
                        <%= f = form_for :foo, "#", [ phx_submit: :assign] %>
                        <%= select f, :team_member_id, @team_members_all, selected: @conversation.team_member_id||"",prompt: "Select Team Member", class: "custom-select"  %>
                        <button type="submit" class="btn btn-primary">
                            Assign
                        </button>
                        </form>

                    </div>
                </div><!-- /.dropdown-menu -->
                <% end %>
                <div class="dropdown" style="display:inline-block;">
                    <%= if @conversation.status == "closed" do %>
                    <button class="btn btn-sm btn-secondary btn-icon dropdown-toggle hide-arrow" type="button"
                            id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        ...
                    </button>
                    <div id="open-close-conversation" class="dropdown-menu dropdown-menu-right"
                         aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" href="#" phx-click="open" phx-value-cid="<%= @conversation.id %>">Open</a>
                    </div>
                    <%  end %>
                    <%= if @conversation.status != "closed" do %>
                    <%= if @dispositions != [] do %>
                    <button type="button" class="btn btn-sm btn-secondary btn-icon dropdown-toggle hide-arrow"
                            data-toggle="modal" data-target="#exampleModalScrollable">...
                    </button>
                    <% else %>
                    <button class="btn btn-sm btn-secondary btn-icon dropdown-toggle hide-arrow" type="button"
                            id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        ...
                    </button>
                    <div id="open-close-conversation" class="dropdown-menu dropdown-menu-right"
                         aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" href="#" phx-click="close" phx-value-cid="<%= @conversation.id %>">Close</a>
                    </div>
                    <% end %>
            <% end %>
                </div>

            </div><!-- /invite members -->
            <% end %>
            <button type="button" class="btn btn-light btn-icon d-xl-none" data-toggle="sidebar"><i
                    class="fa fa-angle-double-left"></i></button>
            <!--Need to add this button element for the sidebar responsive icon-->
        </div>
    </header>
</article>

<section class="message-body">
    <style>
        .scrollable {
            height: 70vh; /* or any value */
            overflow-y: auto;
        }
    </style>

    <div id="scroll-message" class="card card-fluid mb-0 scrollable">
        <section class="conversations" role="log">
            <ul id="convo" class="conversation-list">
                <li class="log-divider">
                    <span>
                        <i class="far fa-fw fa-comment-alt"></i> Conversation started by <strong><%= format_phone(@conversation.original_number) %></strong> ·
                        <%= format_date(@conversation.started_at) %>
                    </span>
                </li>

                <%= for {message, index} <- Enum.with_index(@messages) do %>
                    <% previous_message = Enum.at(@messages, index-1) %>
                    <% next_message = Enum.at(@messages, index+1) %>
                    <% member_name = if @conversation.member, do: [@conversation.member.first_name, @conversation.member.last_name] |> Enum.join(" "), else: " " %>

                <%= if message.phone_number == @conversation.original_number do %>
                <%= if previous_message && message.phone_number == previous_message.phone_number do %>
                <li class="conversation-inbound conversation-faux">
                    <div class="conversation-message conversation-message-skip-avatar">
                        <div class="conversation-message-text"><%= text_to_html(message.message) |> raw %></div>
                        <%= if next_message && next_message.phone_number != message.phone_number do %>
                        <div class="conversation-meta">
                            <%= if member_name != " ", do: member_name, else: "#{format_phone(message.phone_number)}" %>
                            ·
                            <%= format_date(message.sent_at) %>
                        </div>
                        <% end %>
                    </div>
                </li>
                <% else %>
                <li class="conversation-inbound">
                    <div class="conversation-avatar">
                        <a href="#!" class="tile tile-circle bg-muted"><i class="oi oi-person"></i></a>
                    </div>
                    <div class="conversation-message">
                        <div class="conversation-message-text"> <%= text_to_html(message.message) |> raw %></div>
                        <%= if next_message && next_message.phone_number != message.phone_number do %>
                        <div class="conversation-meta">
                            <%= if member_name != " ", do: member_name, else: "#{format_phone(message.phone_number)}" %>
                            ·
                            <%= format_date(message.sent_at) %>
                        </div>
                        <% end %>
                    </div>
                </li>
                <% end %>


                    <% else %>
                <%= cond do %>
                            <% String.contains?(message.message, "OPENED") -> %>
                <li class="log-divider">
                                    <span>
                                        <i class="fa fa-fw fa-user-plus"></i>
                                        Conversation <%= String.replace(message.message, "OPENED:", "") %> · <%= format_date(message.sent_at) %>
                                    </span>
                </li>
                <% String.contains?(message.message, "CLOSED") -> %>
                <li class="log-divider">
                                    <span>
                                        <i class="fa fa-fw fa-user-plus"></i>
                                        Conversation <%= String.replace(message.message, "CLOSED:", "") %> · <%= format_date(message.sent_at) %>
                                    </span>
                </li>
                <% String.contains?(message.message, "ASSIGNED") -> %>
                <li class="log-divider">
                                    <span>
                                        <i class="fa fa-fw fa-user-plus"></i>
                                        <%= String.replace(message.message, "ASSIGNED:", "") %> · <%= format_date(message.sent_at) %>
                                    </span>
                </li>
                <% true -> %>
                <%= if previous_message && message.phone_number != previous_message.phone_number do %>
                <li class="conversation-outbound conversation-faux">
                    <div class="conversation-message conversation-message-skip-avatar">
                        <%= if format_phone(@conversation.original_number) == "Unknown Visitor" do %>
                        <div class="conversation-message-text"><%= message.message |> raw %></div>
                        <% else %>
                        <div class="conversation-message-text"><%= text_to_html(message.message) |> raw %></div>
                        <% end %>
                        <%= if is_nil(next_message) || next_message.phone_number != message.phone_number do %>
                        <div class="conversation-meta">
                            <%= if message.phone_number == @location.phone_number do %>
                            <%= format_assigned(@conversation.original_number) %>
                                                    <% else %>
                            <%= format_phone(message.phone_number) %>
                                                    <% end %>
                            ·
                            <%= format_date(message.sent_at) %>
                        </div>
                        <% end %>
                    </div>
                </li>
                <% else %>
                <li class="conversation-outbound">
                    <div class="conversation-avatar">
                        <a href="#!" class="tile tile-circle bg-muted"><i class="oi oi-person"></i></a>
                    </div>
                    <div class="conversation-message">
                        <div class="conversation-message-text"> <%= text_to_html(message.message) |> raw %></div>
                        <%= if is_nil(next_message) || next_message.phone_number != message.phone_number do %>
                        <div class="conversation-meta">
                            <%= if message.phone_number == @location.phone_number do %>
                            <%= format_assigned(@conversation.original_number) %>
                                                    <% else %>
                            <%= format_phone(message.phone_number) %>
                                                    <% end %>
                            ·
                            <%= format_date(message.sent_at) %>
                        </div>
                        <% else %>
                        <div class="conversation-meta">
                            <% team_member = Enum.find(@team_members, &(&1.user.phone_number == message.phone_number)) %>
                            <%= if team_member do %>
                            <%= format_team_member(team_member.user) %>
                                                    <% else %>
                            <%= format_phone(message.phone_number) %>
                                                    <% end %>
                            ·
                            <%= format_date(message.sent_at) %>
                        </div>
                        <% end %>
                    </div>
                </li>
                <% end %>
                        <% end %>

                    <% end %>

                <% end %>
                <%= live_render(@socket, MainWeb.Live.ConversationMessageUpdatesView, session: %{"user" => @user, "conversation" => @conversation.id } ,id: "update"<>@conversation.id) %>
            </ul>
        </section>
    </div>
</section>

<%= if @conversation.status in ["open", "pending"] do %>
<footer class="message-publisher">
    <%= f = form_for @changeset, "#", [ phx_submit: :save] %>
    <div class="media mb-1">
        <div class="media-body">
            <%= text_input f, :message, id: "reply_matches", class: "form-control border-0 shadow-none", place_holder: "Type a message" %>
        </div>
        <div>
            <button type="submit" class="btn btn-light btn-icon">
                <i class="far fa-paper-plane"></i>
            </button>
        </div>
    </div><!-- /.media -->
    </form>
</footer>

<div style="display: none" id="availableTags">

    <%= for saved_reply <- @saved_replies do %>
            <p><span><%= saved_reply.draft %></span><span><%= saved_reply.title %></span></p>
    <% end %>
</div>


<% end %>

<div class="page-sidebar">
    <header class="sidebar-header d-sm-none"> <!--Need To Add this section. some of the html was missing-->
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a class="prevent-default" href="#" onclick="Looper.toggleSidebar()"><i
                        class="breadcrumb-icon fa fa-angle-left mr-2"></i>Back</a>
            </li>
        </ol>
    </header>
    <div class="sidebar-section">
        <fieldset>
            <legend>Conversation Details</legend>
            <form id="member-form" method="PUT">
                <%= if @conversation.member do %>
                <input name="id" type="hidden" value="<%= @conversation.member.id %>">
                <% end %>
                <input name="member[team_id]" type="hidden" value="<%= @location.team_id %>">
                <div class="form-group">
                    <div class="form-label-group">
                        <input type="text" class="form-control" value="<%= @conversation.location.location_name %>"
                               readonly> <label for="fl1"> Location</label>
                    </div>
                </div><!-- /.form-group -->
                <div class="form-group">
                    <div class="form-label-group">
                        <input name="member[first_name]" type="text" class="form-control"
                               value="<%= if @conversation.member, do: @conversation.member.first_name, else: "N/A" %>">
                        <label for="fl1"> First Name</label>
                    </div>
                </div><!-- /.form-group -->
                <div class="form-group">
                    <div class="form-label-group">
                        <input name="member[last_name]" type="text" class="form-control"
                               value="<%= if @conversation.member, do: @conversation.member.last_name, else: "N/A" %>">
                        <label for="fl1"> Last Name</label>
                    </div>
                </div><!-- /.form-group -->
                <div class="form-group">
                    <div class="form-label-group">
                        <input name="member[phone_number]" type="text" class="form-control"
                               value="<%= if @conversation.member, do: format_phone(@conversation.member.phone_number), else: "N/A" %>">
                        <label for="fl1"> Phone Numbers</label>
                    </div>
                </div><!-- /.form-group -->
                <div class="form-group">
                    <div class="form-label-group">
                        <input name="member[email]" type="text" class="form-control"
                               value="<%= if @conversation.member, do: @conversation.member.email, else: "N/A" %>">
                        <label for="fl1"> Email</label>
                    </div>
                </div><!-- /.form-group -->
                <div class="form-group">
                    <div class="form-label-group">
                        <label> Status</label>
                        <select id="member-status" name="member[status]" class="custom-select">
                            <%= for {key, value} <- member_status() do %>
                            <%= if @conversation.member && @conversation.member.status == value do %>
                            <option value="<%= value %>" selected><%= key %></option>
                            <% else %>
                            <option value="<%= value %>"><%= key %></option>
                            <% end %>
                            <% end %>
                        </select>
                    </div>
                </div>

                <div class="form-actions">
                    <input type="button" value="Update" id="update_member" class="btn btn-primary">
                </div>

            </form>
        </fieldset>
    </div><!-- /.sidebar-section -->
</div>


<!-- Modal -->
<div class="modal fade" id="exampleModalScrollable" tabindex="-1" role="dialog"
     aria-labelledby="exampleModalScrollableTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalScrollableTitle">Close Conversation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div class="form-label-group">
                        <%= for {key, value} <- @dispositions do %>
                        <a class="dropdown-item" href="#" phx-click="close" phx-value-did="<%= value %>"><%= key %></a>
                        <% end %>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<% else  %>
<header id="conversation-tabs" class="section-menu nav-scroller">
    <!-- .nav-tabs -->
    <ul class="nav nav-tabs card-header-tabs">
        <li class="nav-item <%= if @tab == "me", do: " active show",else: ""  %>">
            <a class="nav-link" data-toggle="tab" href="#project-assigned" phx-click="tab" phx-value-tab="me">Me (<%= Enum.count(@my_conversations, &(&1.status in ["open", "pending"])) %>)</a>
        </li>
        <li class="nav-item">
            <a class="nav-link <%= if @tab == "open", do: " active show",else: ""  %>" data-toggle="tab"
               href="#project-open" phx-click="tab" phx-value-tab="open">Open (<%= @count %>)</a>
        </li>
        <li class="nav-item <%= if @tab == "close", do: " active show",else: ""  %>">
            <a class="nav-link" data-toggle="tab" href="#project-closed" phx-click="tab" phx-value-tab="close">Closed (<%= Enum.count(@conversations, fn(c) -> c.status == "closed" end) %>)</a>
        </li>
    </ul>
    <!-- /.nav-tabs -->


</header>

<header class="page-title-bar">
    <div class="d-flex justify-content-between">
        &nbsp;
        <%= if @user.role in ["admin", "team-admin", "location-admin"] do %>

        <a href="#" phx-click="new"
           class="btn btn-primary">
            <i class="fas fa-plus">&nbsp;</i>
            New Message
        </a>
        <% end %>
    </div>
</header>

<div class="page-section">
    <section class="card card-fluid">
        <div class="text-muted px-3 mb-2"></div>

        <div class="tab-content">

            <div class="tab-pane fade<%= if @tab == "me", do: " active show",else: "" %>">
                <!-- .list-group-item -->
                <%= if Enum.count(@my_conversations) == 0 do %>
                <div class="alert alert-info mx-3">You have no assigned conversations for this location</div>
                <% end %>

                <table class="table no-first-border">
                    <tbody>
                    <%= for c <- @my_conversations do %>
                    <tr>
                        <% team_member = (c.team_member || default_user()) %>
                        <td>
        <span class="user-avatar-wrapper">
            <a href="#" class="user-avatar user-avatar-md"><img src="<%= team_member.user.avatar %>" alt=""></a>
            <span>
                <b>
                    <a href="#" phx-click="openconvo" phx-value-lid="<%= @location.id %>" phx-value-tid="<%= @location.team_id %>" phx-value-cid="<%= c.id %>">
                        <%= if !c.team_member do %>
                            <%=  format_assigned(c.original_number) %>
                        <% else %>
                            <%= team_member.user.first_name %> <%= team_member.user.last_name %>
                        <% end %>
                    </a>
                </b>
                <span class="list-group-item-text"><%= String.replace(team_member.user.role, "-", " ") |> String.capitalize() %></span>
            </span>
        </span>
                        </td>
                        <td>

                            <%= if c.member && c.member.first_name do %>
                            <b><a href="#" phx-click="openconvo" phx-value-lid="<%= @location.id %>" phx-value-tid="<%= @location.team_id %>" phx-value-cid="<%= c.id %>"><%= Enum.join([c.member.first_name, c.member.last_name], " ") %></a></b>
                            <% else %>
                            <b><a href="#" phx-click="openconvo" phx-value-lid="<%= @location.id %>" phx-value-tid="<%= @location.team_id %>" phx-value-cid="<%= c.id %>"><%= format_phone(c.original_number) %></a></b>
                            <% end %>
                            <p class="list-group-item-text"><%= List.first(c.conversation_messages).message |> String.slice(0..100) %>&hellip;</p>
                        </td>
                        <td>
                            <%= List.first(c.conversation_messages).sent_at |> format_date() %>
                        </td>
                        <td>
                            <div class="dropdown">
                                <%= if c.status == "closed" do %>
                                <button class="btn btn-sm btn-secondary btn-icon dropdown-toggle hide-arrow" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    ...
                                </button>
                                <div id="open-close-conversation" class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                    <a class="dropdown-item" href="#" phx-click="open" phx-value-cid="<%= c.id %>">Open</a>
                                </div>
                                <%  end %>
                                <%= if c.status != "closed" do %>
                                <%= if @dispositions != [] do %>
                                <button type="button" class="btn btn-sm btn-secondary btn-icon dropdown-toggle hide-arrow" data-toggle="modal" data-target="#mmodal<%= c.id %>">...</button>
                                <!-- Modal -->
                                <div class="modal fade" id="mmodal<%= c.id %>" tabindex="-1" role="dialog" aria-labelledby="exampleModalScrollableTitle" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalScrollableTitle">Close Conversation</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="form-group">
                                                    <div class="form-label-group">
                                                        <%= for {key, value} <- @dispositions do %>
                                                        <a class="dropdown-item" href="#" phx-click="close" phx-value-did="<%= value %>"  phx-value-cid="<%= c.id %>"><%= key %></a>
                                                        <% end %>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <% else %>
                                <button class="btn btn-sm btn-secondary btn-icon dropdown-toggle hide-arrow" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">...</button>
                                <div id="open-close-conversation" class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                    <a class="dropdown-item" href="#" phx-click="close" phx-value-cid="<%= c.id %>">Close</a>
                                </div>
                                <% end %>
            <% end %>
                            </div>
                        </td>
                    </tr>
                    <% end %>
                    </tbody>
                </table>
            </div>

            <div class="tab-pane fade <%= if @tab == "open", do: " active show",else: ""  %>">
                <%= if Enum.count(@conversations, &(&1.status in ["open", "pending"])) == 0 do %>
                <div class="alert alert-info mx-3">There are no open conversations for this location.</div>
                <% end %>

                <table class="table no-first-border">
                    <tbody>
                    <%= for c <- Enum.filter(@conversations, &(&1.status in ["open", "pending"])) do %>
                    <tr>
                        <% team_member = (c.team_member || default_user()) %>
                        <td>
        <span class="user-avatar-wrapper">
            <a href="#" class="user-avatar user-avatar-md"><img src="<%= team_member.user.avatar %>" alt=""></a>
            <span>
                <b>
                    <a href="#" phx-click="openconvo" phx-value-lid="<%= @location.id %>" phx-value-tid="<%= @location.team_id %>" phx-value-cid="<%= c.id %>">
                        <%= if !c.team_member do %>
                            <%=  format_assigned(c.original_number) %>
                        <% else %>
                            <%= team_member.user.first_name %> <%= team_member.user.last_name %>
                        <% end %>
                    </a>
                </b>
                <span class="list-group-item-text"><%= String.replace(team_member.user.role, "-", " ") |> String.capitalize() %></span>
            </span>
        </span>
                        </td>
                        <td>

                            <%= if c.member && c.member.first_name do %>
                            <b><a href="#" phx-click="openconvo" phx-value-lid="<%= @location.id %>" phx-value-tid="<%= @location.team_id %>" phx-value-cid="<%= c.id %>"><%= Enum.join([c.member.first_name, c.member.last_name], " ") %></a></b>
                            <% else %>
                            <b><a href="#" phx-click="openconvo" phx-value-lid="<%= @location.id %>" phx-value-tid="<%= @location.team_id %>" phx-value-cid="<%= c.id %>"><%= format_phone(c.original_number) %></a></b>
                            <% end %>
                            <p class="list-group-item-text"><%= List.first(c.conversation_messages).message |> String.slice(0..100) %>&hellip;</p>
                        </td>
                        <td>
                            <%= List.first(c.conversation_messages).sent_at |> format_date() %>
                        </td>
                        <td>
                            <div class="dropdown">
                                <%= if c.status == "closed" do %>
                                <button class="btn btn-sm btn-secondary btn-icon dropdown-toggle hide-arrow" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    ...
                                </button>
                                <div id="open-close-conversation" class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                    <a class="dropdown-item" href="#" phx-click="open" phx-value-cid="<%= c.id %>">Open</a>
                                </div>
                                <%  end %>
                                <%= if c.status != "closed" do %>
                                <%= if @dispositions != [] do %>
                                <button type="button" class="btn btn-sm btn-secondary btn-icon dropdown-toggle hide-arrow" data-toggle="modal" data-target="#omodal<%= c.id %>">...</button>
                                <!-- Modal -->
                                <div class="modal fade" id="omodal<%= c.id %>" tabindex="-1" role="dialog" aria-labelledby="exampleModalScrollableTitle" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalScrollableTitle">Close Conversation</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="form-group">
                                                    <div class="form-label-group">
                                                        <%= for {key, value} <- @dispositions do %>
                                                        <a class="dropdown-item" href="#" phx-click="close" phx-value-did="<%= value %>" phx-value-cid="<%= c.id %>"><%= key %></a>
                                                        <% end %>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <% else %>
                                <button class="btn btn-sm btn-secondary btn-icon dropdown-toggle hide-arrow" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">...</button>
                                <div id="open-close-conversation" class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                    <a class="dropdown-item" href="#" phx-click="close" phx-value-cid="<%= c.id %>">Close</a>
                                </div>
                                <% end %>
            <% end %>
                            </div>
                        </td>
                    </tr>
                    <% end %>
                    </tbody>
                </table>
            </div>

            <div class="tab-pane fade <%= if @tab == "close", do: " active show",else: ""  %>">
                <%= if Enum.count(@conversations, &(&1.status == "closed")) == 0 do %>
                <div class="alert alert-info mx-3">There are no closed conversations for this location.</div>
                <% end %>

                <table class="table no-first-border">
                    <tbody>
                    <%= for c <- Enum.filter(@conversations, &(&1.status == "closed")) do %>
                    <tr>
                        <% team_member = (c.team_member || default_user()) %>
                        <td>
        <span class="user-avatar-wrapper">
            <a href="#" class="user-avatar user-avatar-md"><img src="<%= team_member.user.avatar %>" alt=""></a>
            <span>
                <b>
                    <a href="#" phx-click="openconvo" phx-value-lid="<%= @location.id %>" phx-value-tid="<%= @location.team_id %>" phx-value-cid="<%= c.id %>">
                        <%= if !c.team_member do %>
                            <%=  format_assigned(c.original_number) %>
                        <% else %>
                            <%= team_member.user.first_name %> <%= team_member.user.last_name %>
                        <% end %>
                    </a>
                </b>
                <span class="list-group-item-text"><%= String.replace(team_member.user.role, "-", " ") |> String.capitalize() %></span>
            </span>
        </span>
                        </td>
                        <td>

                            <%= if c.member && c.member.first_name do %>
                            <b><a href="#" phx-click="openconvo" phx-value-lid="<%= @location.id %>" phx-value-tid="<%= @location.team_id %>" phx-value-cid="<%= c.id %>"><%= Enum.join([c.member.first_name, c.member.last_name], " ") %></a></b>
                            <% else %>
                            <b><a href="#" phx-click="openconvo" phx-value-lid="<%= @location.id %>" phx-value-tid="<%= @location.team_id %>" phx-value-cid="<%= c.id %>"><%= format_phone(c.original_number) %></a></b>
                            <% end %>
                            <p class="list-group-item-text"><%= List.first(c.conversation_messages).message |> String.slice(0..100) %>&hellip;</p>
                        </td>
                        <td>
                            <%= List.first(c.conversation_messages).sent_at |> format_date() %>
                        </td>
                        <td>
                            <div class="dropdown">
                                <%= if c.status == "closed" do %>
                                <button class="btn btn-sm btn-secondary btn-icon dropdown-toggle hide-arrow" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    ...
                                </button>
                                <div id="open-close-conversation" class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                    <a class="dropdown-item" href="#" phx-click="open" phx-value-cid="<%= c.id %>">Open</a>
                                </div>
                                <%  end %>
                                <%= if c.status != "closed" do %>
                                <%= if @dispositions != [] do %>
                                <button type="button" class="btn btn-sm btn-secondary btn-icon dropdown-toggle hide-arrow" data-toggle="modal" data-target="#omodal<%= c.id %>">...</button>
                                <!-- Modal -->
                                <div class="modal fade" id="omodal<%= c.id %>" tabindex="-1" role="dialog" aria-labelledby="exampleModalScrollableTitle" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalScrollableTitle">Close Conversation</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="form-group">
                                                    <div class="form-label-group">
                                                        <%= for {key, value} <- @dispositions do %>
                                                        <a class="dropdown-item" href="#" phx-click="close" phx-value-did="<%= value %>" phx-value-cid="<%= c.id %>"><%= key %></a>
                                                        <% end %>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <% else %>
                                <button class="btn btn-sm btn-secondary btn-icon dropdown-toggle hide-arrow" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">...</button>
                                <div id="open-close-conversation" class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                    <a class="dropdown-item" href="#" phx-click="close" phx-value-cid="<%= c.id %>">Close</a>
                                </div>
                                <% end %>
                            <% end %>
                            </div>
                        </td>
                    </tr>
                    <% end %>
                    </tbody>
                </table>
            </div>

        </div>

    </section>
</div>
<% end %>
<% end %>
<script>
    var availableTags = [
    ];
    $(document).on('click','#update_member',function (e) {
        e.preventDefault(); // prevent default action of link

        $.ajax({
            url: '/api/update-member',
            type: 'PUT',
            data: $("#member-form").serialize(),
            success: function (data) {
                alert("You have successfully updated the member data");
                // window.location.reload();
            },
            error: function (data) {
                var response = data.responseJSON.message;
                alert(response);
            }
        });
    });
    $(document).on('DOMSubtreeModified', 'body', function () {
        if($('.modal-backdrop').is(":visible")){
        $('.modal-backdrop').remove();}
        if($('#conversation_scheduled').is(':checked') )
        {
            $( ".form_date" ).show(500);
            $(".form_btn").html("Schedule");
        }
        $( "#conversation_original_number" ).prop('required',true);
        $( "#conversation_message" ).prop('required',true);
        $( ".form_name" ).hide();
        $( ".form_csv" ).hide();
        $( ".form_date" ).hide();
        $(".form_schedule").hide();
    })
    $('body').on('DOMSubtreeModified', '#scroll-message', function () {
        var div = document.getElementById("scroll-message");
        div.scrollTop = div.scrollHeight;
         $("#availableTags p").each(function(i,elem)
        {
            span = $(elem).find('span');
            if (span.length)
            {
                availableTags.push({value: span[0].innerText, label: span[1].innerText})

            }        });
        $("#reply_matches").autocomplete({
            source: function (request, response) {
                var term_ = request.term
                if (term_ == "#") {
                    response(availableTags)
                } else {
                    var term = term_.replace("#", "");
                    var reg = new RegExp($.ui.autocomplete.escapeRegex(term), "i")
                    if (term !== "") response($.grep(availableTags, function (tag) {
                        return tag.label.match(reg)
                    }))
                }
            },
            position: {
                my: "left bottom",
                at: "left top-9",
            },
            _resizeMenu: function () {
                this.menu.element.outerWidth(250);
            }
        });
    });

    $(document).on('click','#rd2',function (e) {
        $( ".form_to" ).hide(500);
        $( ".form_name" ).show(500);
        $( ".form_name" ).show(500);
        $(".form_schedule").show(500);
        $( "#rd2" ).addClass( "show active" );
        $( "#rd1" ).removeClass( "show active" );
        $( "#conversation_csv" ).prop('required',true);
        $( "#conversation_campaign_name" ).prop('required',true);
        $("#conversation_original_number").removeAttr('required');
        $( "#conversation_original_number" ).val('');
        $( ".form_csv" ).show(500);
        if($('#conversation_scheduled').is(':checked') )
        {
            $( ".form_date" ).show(500);
            $(".form_btn").html("Schedule");
        }
    });
    $(document).on('click','#rd1',function (e) {
        $( ".form_to" ).show(500);
        $( "#rd1" ).addClass( "show active" );
        $( "#rd2" ).removeClass( "show active" );
        $( ".form_name" ).hide(500);
        $(".form_schedule").hide(500);
        $("#conversation_csv").removeAttr('required');
        $("#conversation_campaign_name").removeAttr('required');
        $( "#conversation_original_number" ).prop('required',true);
        $( "#conversation_campaign_name" ).val('');
        $( ".form_csv" ).hide(500);
        $( ".form_date" ).hide(500);
    });
    $(document).on('click','#conversation_scheduled',function (e) {
        if(conversation_scheduled.checked) {
            $( ".form_date" ).show(500);
            $(".form_btn").html("Schedule");
        } else {
            $( ".form_date" ).hide(500);
            $(".form_btn").html("Send Now");
        }
    });

</script>
